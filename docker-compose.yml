# =============================================================================
# Kyx Governance Server - Docker Compose
# =============================================================================
# Development/Production deployment configuration with SurrealDB dependency
# =============================================================================

services:
  kyx-governance:
    build:
      context: .
      dockerfile: Dockerfile
    image: kyx/governance
    container_name: kyx-governance-app
    restart: unless-stopped
    ports:
      - "${PORT:-3001}:3001"
    environment:
      - RUST_LOG=${RUST_LOG:-info}
      # SurrealDB Connection
      - SURREAL_URL=ws://kyx-governance-surrealdb:8000/rpc
      - SURREAL_USER=${SURREAL_USER:-root}
      - SURREAL_PASS=${SURREAL_PASS:-c31256bbba78c60c09cfa90c65fb533b96fd1bb27a22be2f}
      - SURREAL_NAMESPACE=${SURREAL_NAMESPACE:-kyx}
      - SURREAL_DATABASE=${SURREAL_DATABASE:-governance}
      # Authentication
      - MCP_API_KEY=${MCP_API_KEY}
      - QDRANT_URL=http://qdrant:6333
      - OPENAI_API_KEY=${OPENAI_API_KEY}
    depends_on:
      surrealdb:
        condition: service_healthy
    networks:
      - kyx-network
    healthcheck:
      test: ["CMD-SHELL", "curl -sf http://localhost:3001/health || exit 1"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 15s

  # SurrealDB for Governance Data
  surrealdb:
    image: surrealdb/surrealdb:v2.4.0
    container_name: kyx-governance-surrealdb
    restart: unless-stopped
    user: root
    command: start --user ${SURREAL_USER:-root} --pass ${SURREAL_PASS:-c31256bbba78c60c09cfa90c65fb533b96fd1bb27a22be2f} rocksdb:/var/lib/surreal/data.db
    volumes:
      - surreal-data:/var/lib/surreal
      - surreal-data:/data
      - surreal-logs:/logs # <--- Fix anonymous volumes here too!
    ports:
      - "${SURREAL_PORT:-8000}:8000"
    environment:
      SURREAL_USER: ${SURREAL_USER:-root}
      SURREAL_PASS: ${SURREAL_PASS:-c31256bbba78c60c09cfa90c65fb533b96fd1bb27a22be2f}
    networks:
      - kyx-network
    healthcheck:
      test: ["CMD", "/surreal", "isready"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 5s

  # Qdrant for Vector Storage
  qdrant:
    image: qdrant/qdrant:latest
    container_name: kyx-governance-qdrant
    restart: unless-stopped
    ports:
      - "${QDRANT_PORT:-6335}:6333"
      - "${QDRANT_GRPC_PORT:-6334}:6334"
    volumes:
      - qdrant-data:/qdrant/storage
    networks:
      - kyx-network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:6333/health"]
      interval: 10s
      timeout: 5s
      retries: 5

networks:
  kyx-network:
    driver: bridge

volumes:
  surreal-data:
  surreal-logs:
  qdrant-data:
